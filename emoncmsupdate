#!/bin/bash

echo
echo "================================="
echo "Emoncms update started"
echo

date

echo

echo "git pull /var/www/emoncms"
cd /var/www/emoncms
git pull

echo

echo "git pull /var/www/emoncms/Modules/nodes"
cd /var/www/emoncms/Modules/nodes
git pull

echo

echo "git pull /var/www/emoncms/Modules/app"
cd /var/www/emoncms/Modules/app
git pull

echo

echo "git pull /var/www/emoncms/Modules/config"
cd /var/www/emoncms/Modules/config
git pull

echo

echo "git pull /var/www/emoncms/Modules/wifi"
cd /var/www/emoncms/Modules/wifi
git pull

echo

echo "git pull /home/pi/emonhub"
cd /home/pi/emonhub
git pull

echo "git pull /home/pi/oem_openHab"
cd /home/pi/oem_openHab
git pull

echo

if ! grep -q "V2.x_emonTH_DHT22_DS18B20_RFM69CW_Pulse" /home/pi/data/emonhub.conf ; then
  echo "Appending emonTH V2.x pulse counting node decoding additions to /home/pi/data/emonhub.conf..."
  echo -e "$(</home/pi/emonpi/emonhub.conf_emonTHaddition)" >> /home/pi/data/emonhub.conf
  echo "..Done"
fi

if ! grep -q "V2_3_emonTxV3_4_DiscreteSampling" /home/pi/data/emonhub.conf ; then
  echo "Appending emonTx V2.3 pulse counting node decoding additions to /home/pi/data/emonhub.conf..."
  echo -e "$(</home/pi/emonpi/emonhub.conf_emonTxaddition)" >> /home/pi/data/emonhub.conf
  echo "..Done"
fi

echo
sudo /etc/init.d/emonhub restart
echo
sudo /etc/init.d/emoncms-nodes-service restart
echo
sudo /etc/init.d/feedwriter restart

echo
echo "Emoncms update finished"
echo "================================="
echo
